#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/11/19# @Author : cyq# @File : runner# @Software: PyCharm# @Desc:import jsonfrom typing import List, Dict, Any, Mapping, TypeVar, Tuplefrom httpx import Responsefrom app.mapper.interface.interfaceGroupMapper import InterfaceGroupMapperfrom app.mapper.interface.interfaceVarsMapper import InterfaceVarsMapperfrom app.mapper.project.dbConfigMapper import DbConfigMapperfrom app.mapper.project.env import EnvMapperfrom app.model.interface import InterfaceModel, InterfaceCaseResultModel, InterFaceCaseModel, InterfaceTaskResultModel, \    InterfaceVariablesfrom enums import InterfaceExtractTargetVariablesEnum, InterfaceResponseStatusCodeEnum, InterfaceAPIResultEnum, \    InterfaceCaseErrorStepfrom utils import MyLoguru, GenerateToolsfrom app.mapper.interface import InterfaceMapper, InterfaceCaseMapper, InterfaceGlobalVariableMapperfrom common.fakerClient import FakerClientfrom utils.execDBScript import ExecDBScriptfrom utils.transform import Transformfrom interface.exec import *from .sender import HttpSenderfrom .starter import APIStarterfrom .writer import InterfaceAPIWriterlog = MyLoguru().get_logger()Interface = TypeVar('Interface', bound=InterfaceModel)InterfaceCase = TypeVar('InterfaceCase', bound=InterFaceCaseModel)Interfaces = List[Interface]async def set_req_url(interface: Interface) -> str:    """    è®¾ç½®è¯·æ±‚url    :param interface:    :return:    """    try:        if interface.env_id == -1:            return interface.url        else:            env = await EnvMapper.get_by_id(ident=interface.env_id)            domain = env.host            if env.port:                domain += f":{env.port}"            return domain + interface.url    except Exception as e:        log.error(f"è®¾ç½®è¯·æ±‚urlå¤±è´¥ = {e}")        raise ValueError("è¯·æ±‚ç¯å¢ƒä¸å­˜åœ¨ã€è¯·æ£€æŸ¥")class InterFaceRunner:    response: Response | str = None    def __init__(self, starter: APIStarter):        self.starter = starter        self.variables = {}        self.sender = HttpSender(self.variables, self.starter)    def set_variables(self, data: Dict[str, Any] | List[Dict[str, Any]]) -> Dict[str, Any]:        """        è®¾ç½®å˜é‡        :param data:        :return:        """        if isinstance(data, dict):            self.variables.update(**data)        elif isinstance(data, list):            data = GenerateTools.list2dict(data)            self.variables.update(**data)        return data    async def try_interface(self, interface: int) -> Mapping[str, Any]:        """        æ‰§è¡Œå•ä¸ªæ¥å£è¯·æ±‚è°ƒè¯•        æ— å˜é‡ã€æœ‰å‰ç½®æ–¹æ³•ã€        éœ€è¦è¿”å›response        """        interface = await InterfaceMapper.get_by_id(ident=interface)        result, _ = await self.__execute_interface(interface)        return result    async def get_interface(self, interfaceId: int):        """è·å–æ¥å£ä¿¡æ¯"""        interface: Interface = await InterfaceMapper.get_by_id(ident=interfaceId)        if interface.env_id == -1:            from utils import Tools            parse = Tools.parse_url(interface.url)            url = parse.path            host = f"{parse.scheme}://{parse.netloc}"        else:            env = await EnvMapper.get_by_id(ident=interface.env_id)            host = env.host            url = interface.url            if env.port:                host += f":{env.port}"        # 1ã€å‰ç½®å˜é‡å‚æ•°        await self.__exec_before_params(interface.before_params)        # 2ã€æ‰§è¡Œå‰ç½®å‡½æ•°        await self.__exec_before_script(interface.before_script)        # 3.å‰ç½®sql        await self.__exec_before_sql(interface)        url = await self.sender.transform_target(target=url)        info = await self.sender.set_req_info(interface)        info.pop("follow_redirects")        info.pop("read")        info.pop("connect")        return {            "method": interface.method.lower(),            "url": url,            "host": host,            **info        }    async def try_group(self, groupId: int):        """        æ‰§è¡Œæ¥å£ç»„        """        interfaces: Interfaces = await InterfaceGroupMapper.query_apis(groupId=groupId)        results = []        for interface in interfaces:            await self.starter.send(f"execute  ï¼š {interface}")            result, _ = await self.__execute_interface(interface)            results.append(result)        return results    async def run_interface_by_task(self, interface: Interface, taskResult: InterfaceTaskResultModel) -> bool:        """ä»»åŠ¡æ‰§è¡Œapi"""        result, _ = await self.__execute_interface(interface=interface, taskResult=taskResult)        await InterfaceAPIWriter.write_interface_result(**result)        return _    async def run_interfaceCase_by_task(self, interfaceCase: InterfaceCase,                                        taskResult: InterfaceTaskResultModel) -> bool:        """ä»»åŠ¡æ‰§è¡Œcase"""        interfaces: Interfaces = await InterfaceCaseMapper.query_interface_by_caseId(caseId=interfaceCase.id)        await self.starter.send(f"ç”¨ä¾‹ {interfaceCase.title} æ‰§è¡Œå¼€å§‹ã€‚æ‰§è¡Œäºº {self.starter.username}")        await self.starter.send(f"æŸ¥è¯¢åˆ°å…³è”API x {len(interfaces)} ...")        interfacesNum = len(interfaces)        caseResult = await InterfaceAPIWriter.init_interface_case_result(interfaceCase=interfaceCase,                                                                         taskId=taskResult.id,                                                                         starter=self.starter)        await self.starter.send(f"åˆå§‹åŒ–ç»“æœæ¨¡å‹ ã€‚ã€‚ã€‚ âœ… ID= '{caseResult.uid}'")        _f = True        try:            for index, interface in enumerate(interfaces, start=1):                await self.starter.send(f"execute  Step {index} ï¼š {interface}")                if interface.is_group:                    # æ‰§è¡Œæ­¥éª¤ç»„                    group_interfaces: Interfaces = await InterfaceGroupMapper.query_apis(groupId=interface.group_id)                    for _index, _interface in enumerate(group_interfaces, start=1):                        await self.starter.send(f"execute Group Step {_index} : {_interface} ")                        result, flag = await self.__execute_interface(interface=_interface, caseResult=caseResult)                        await InterfaceAPIWriter.write_interface_result(interfaceGroupId=interface.group_id, **result)                        if not flag:                            _f = False                            caseResult.result = InterfaceAPIResultEnum.ERROR                            break                else:                    result, flag = await self.__execute_interface(interface=interface, caseResult=caseResult)                    # å…¥åº“                    await InterfaceAPIWriter.write_interface_result(**result)                    caseResult.progress = round(index / interfacesNum, 1) * 100                    if flag:                        caseResult.success_num += 1                    else:                        _f = False                        caseResult.result = InterfaceAPIResultEnum.ERROR                        caseResult.fail_num += 1                        if interfaceCase.error_stop == InterfaceCaseErrorStep.STOP:                            caseResult.progress = 100                            break                await InterfaceAPIWriter.write_process(caseResult=caseResult)            caseResult.interfaceLog = "".join(self.starter.logs)            await InterfaceAPIWriter.write_interface_case_result(caseResult=caseResult)            return _f        finally:            await self.starter.send(f"ç”¨ä¾‹ {interfaceCase.title} æ‰§è¡Œç»“æŸ")            await self.starter.send(f"{'====' * 20}")    async def run_interCase(self, interfaceCaseId: int):        """        æ‰§è¡Œæ¥å£ç”¨ä¾‹        """        interfaceCase: InterfaceCase = await InterfaceCaseMapper.get_by_id(ident=interfaceCaseId)        interfaces: Interfaces = await InterfaceCaseMapper.query_interface_by_caseId(caseId=interfaceCaseId)        await self.starter.send(f"ç”¨ä¾‹ {interfaceCase.title} æ‰§è¡Œå¼€å§‹ã€‚æ‰§è¡Œäºº {self.starter.username}")        await self.starter.send(f"æŸ¥è¯¢åˆ°å…³è”API x {len(interfaces)} ...")        interfacesNum = len(interfaces)        if interfacesNum == 0:            return await self.starter.over()        # åŠ è½½ç”¨ä¾‹ä¸“å±å˜é‡        await self.__init_interface_case_vars(interfaceCase)        caseResult = await InterfaceAPIWriter.init_interface_case_result(interfaceCase=interfaceCase,                                                                         starter=self.starter)        await self.starter.send(f"åˆå§‹åŒ–ç»“æœæ¨¡å‹ ã€‚ã€‚ã€‚ âœ… ID= '{caseResult.uid}'")        try:            for index, interface in enumerate(interfaces, start=1):                await self.starter.send(f"âœï¸âœï¸ EXECUTE  Step {index} ï¼š {interface}")                if interface.enable == 0:                    await self.starter.send(f"âœï¸âœï¸ EXECUTE Step {index} ï¼š è°ƒè¯•ç¦ç”¨ è·³è¿‡æ‰§è¡Œ")                    continue                if interface.is_group:                    group_interfaces: Interfaces = await InterfaceGroupMapper.query_apis(groupId=interface.group_id)                    for _index, _interface in enumerate(group_interfaces, start=1):                        await self.starter.send(f"âœï¸âœï¸  EXECUTE Group Step {_index} : {_interface} ")                        result, flag = await self.__execute_interface(interface=_interface, caseResult=caseResult)                        await InterfaceAPIWriter.write_interface_result(interfaceGroupId=interface.group_id, **result)                        if not flag:                            caseResult.result = InterfaceAPIResultEnum.ERROR                            break                else:                    result, flag = await self.__execute_interface(interface=interface, caseResult=caseResult)                    # å…¥åº“                    await InterfaceAPIWriter.write_interface_result(**result)                    caseResult.progress = round(index / interfacesNum, 1) * 100                    if flag:                        caseResult.success_num += 1                    else:                        caseResult.result = InterfaceAPIResultEnum.ERROR                        caseResult.fail_num += 1                        if interfaceCase.error_stop == InterfaceCaseErrorStep.STOP:                            caseResult.progress = 100                            break                await InterfaceAPIWriter.write_process(caseResult=caseResult)                await self.starter.send(f"âœ…âœ…ï¸ FINISH   Step {index} ï¼š {interface}")                await self.starter.send(f"\n")            await self.starter.send(f"ç”¨ä¾‹ {interfaceCase.title} æ‰§è¡Œç»“æŸ")            await self.starter.send(f"{'====' * 20}")            caseResult.interfaceLog = "".join(self.starter.logs)            return await InterfaceAPIWriter.write_interface_case_result(caseResult=caseResult)        finally:            await self.starter.over(caseResult.id)    async def __execute_interface(self,                                  interface: InterfaceModel,                                  caseResult: InterfaceCaseResultModel = None,                                  taskResult: InterfaceTaskResultModel = None                                  ) -> Tuple[Mapping[str, Any], bool]:        """        API æ‰§è¡Œ        è¿”å›æ‰§è¡Œç»“æœï¼Œflag        """        temp_variables = []        asserts_info = None        url = None        try:            # -1 åˆå§‹åŒ–å…¨å±€å˜é‡            await self.__init_interface_global_vars()            # 0ã€æ¥å£å¤„ç†è¯·æ±‚URL            url = await set_req_url(interface)            # 1ã€å‰ç½®å˜é‡å‚æ•°            temp_variables.extend(await self.__exec_before_params(interface.before_params))            # 2ã€æ‰§è¡Œå‰ç½®å‡½æ•°            temp_variables.extend(await self.__exec_before_script(interface.before_script))            # 3.å‰ç½®sql            temp_variables.extend(await self.__exec_before_sql(interface))            # 4ã€æ‰§è¡Œæ¥å£è¯·æ±‚            self.response = await self.sender(url=url, interface=interface)            # 5ã€è¿›è¡Œæ–­è¨€            asserts_info = await self.__exec_assert(interface)            # 6ã€å‡ºå‚æå–            temp_variables.extend(await self.__exec_extract(interface))            # 7ã€æ‰§è¡Œåç½®å‡½æ•°            temp_variables.extend(await self.__exec_after_script(interface))        except Exception as e:            log.exception(e)            await self.starter.send(f"Error occurred: \"{str(e)}\"")            self.response = f"{str(e)} to {url}"        finally:            return await  InterfaceAPIWriter.set_interface_result_info(                starter=self.starter,                interface=interface,                response=self.response,                asserts=asserts_info,                caseResult=caseResult,                taskResult=taskResult,                variables=temp_variables            )    async def __exec_before_script(self, script: str) -> List[Any] | List[Mapping[str, Any]]:        """å¤„ç†å‰ç½®è„šæœ¬"""        if script:            exe = ExecScriptForInterface()            _extracted_vars = self.set_variables(exe.exec_script(script))            await self.starter.send(f"ğŸ«³ğŸ«³ å‰ç½®è„šæœ¬ = {json.dumps(_extracted_vars, ensure_ascii=False)}")            _vars = [                {                    InterfaceExtractTargetVariablesEnum.KEY: k,                    InterfaceExtractTargetVariablesEnum.VALUE: v,                    InterfaceExtractTargetVariablesEnum.Target: InterfaceExtractTargetVariablesEnum.BeforeScript                }                for k, v in _extracted_vars.items()            ]            return _vars        return []    async def __exec_before_params(self, before_params: List[Dict[str, Any]] = None):        """å¤„ç†å‰ç½®å‚æ•°"""        if before_params:            trans = Transform(self.variables)            values = await trans.transform_target(before_params)            _extracted_vars = self.set_variables(values)            await self.starter.send(f"ğŸ«³ğŸ«³ å‰ç½®å‚æ•° = {json.dumps(_extracted_vars, ensure_ascii=False)}")            _vars = [                {                    InterfaceExtractTargetVariablesEnum.KEY: k,                    InterfaceExtractTargetVariablesEnum.VALUE: v,                    InterfaceExtractTargetVariablesEnum.Target: InterfaceExtractTargetVariablesEnum.BeforeParams                }                for k, v in _extracted_vars.items()            ]            return _vars        return []    async def __exec_before_sql(self, interface: InterfaceModel):        """        æ‰§è¡Œå‰ç½®sql æ“ä½œ        ## Select            sql:str            - select username from user => [{username:xxx}{username:xxx}][0]            - select username as un  from user => [{un:xxx}{un:xxx}][0]            sql_extracts: [{key:username,jp:$[0].username},{key:username,jp:$[1].username}]            - select username from user => [{username:xxx}{username:xxx}]            ==>  [{username:xx},{username:xx}]        ## Update        """        # ä¸æ‰§è¡Œ        if not interface.before_sql or not interface.before_db_id:            return []        _db = await DbConfigMapper.get_by_id(interface.before_db_id)        if not _db:            log.warning(f"æœªæ‰¾åˆ°æ•°æ®åº“é…ç½® ID: {interface.before_db_id}")            return []        trans = Transform(self.variables)        script = await trans.transform_target(interface.before_sql.strip())        db_script = ExecDBScript(self.starter, script, interface.before_sql_extracts)        res = await db_script.invoke(_db.db_type, **_db.config)        await self.starter.send(f"ğŸ«³ğŸ«³ æ•°æ®åº“è¯»å– = {json.dumps(res, ensure_ascii=False)}")        if res:            _vars = [                {                    InterfaceExtractTargetVariablesEnum.KEY: k,                    InterfaceExtractTargetVariablesEnum.VALUE: v,                    InterfaceExtractTargetVariablesEnum.Target: InterfaceExtractTargetVariablesEnum.BeforeSQL                }                for k, v in res.items()            ]            return _vars        return []    async def __exec_assert(self, interface: InterfaceModel):        """        å“åº”æ–­è¨€        å‰æï¼š        1ã€æœ‰æ–­è¨€        2ã€æœ‰å“åº”        3ã€å“åº”200        """        if interface.asserts and self.response.status_code == InterfaceResponseStatusCodeEnum.SUCCESS:            _assert = ExecAsserts(self.response)            return await _assert(interface.asserts)    async def __exec_extract(self, interface: InterfaceModel):        """        å˜é‡æå–        å‰æï¼š        1ã€æœ‰æ–­è¨€        2ã€æœ‰å“åº”        3ã€å“åº”200        """        if interface.extracts and self.response.status_code == InterfaceResponseStatusCodeEnum.SUCCESS:            _extract = ExecResponseExtract(response=self.response)            _vars = await _extract(interface.extracts)            await self.starter.send(f"ğŸ«³ğŸ«³  å“åº”å‚æ•°æå– = {json.dumps(_vars, ensure_ascii=False)}")            self.set_variables(_vars)            return _vars        return []    async def __exec_after_script(self, interface: InterfaceModel):        """        æ‰§è¡Œåç½®è„šæœ¬        """        if interface.after_script and self.response.status_code == InterfaceResponseStatusCodeEnum.SUCCESS:            exe = ExecScriptForInterface(response=self.response)            extracted_vars = self.set_variables(exe.exec_script(interface.after_script))            await self.starter.send(f"ğŸ«³ğŸ«³ å‰ç½®è„šæœ¬ = {json.dumps(extracted_vars, ensure_ascii=False)}")            _vars = [                {                    InterfaceExtractTargetVariablesEnum.KEY: k,                    InterfaceExtractTargetVariablesEnum.VALUE: v,                    InterfaceExtractTargetVariablesEnum.Target: InterfaceExtractTargetVariablesEnum.AfterScript                }                for k, v in extracted_vars.items()            ]            return _vars        return []    async def __init_interface_case_vars(self, interfaceCase: InterfaceCase):        """åˆå§‹åŒ–ç”¨ä¾‹å˜é‡"""        try:            interfaceCaseVars: List[InterfaceVariables] = await InterfaceVarsMapper.query_by(case_id=interfaceCase.id)            f = FakerClient()            if interfaceCaseVars:                for var in interfaceCaseVars:                    if var.value.startswith("{{$"):                        _v = var.value[3:-2]                        self.variables[var.key] = f.value(_v)                    else:                        self.variables[var.key] = var.value            if self.variables:                await self.starter.send(f"ğŸ«³ğŸ«³ åˆå§‹åŒ–ç”¨ä¾‹å˜é‡ = {json.dumps(self.variables, ensure_ascii=False)}")        except Exception as e:            log.error(e)    async def __init_interface_global_vars(self):        try:            g_vars = await InterfaceGlobalVariableMapper.query_all()            if g_vars:                for g_var in g_vars:                    self.variables[g_var.key] = g_var.value        except Exception as e:            log.warning(e)