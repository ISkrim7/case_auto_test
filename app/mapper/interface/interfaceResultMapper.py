#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/11/20# @Author : cyq# @File : interfaceResultMapper# @Software: PyCharm# @Desc:from typing import Listfrom app.mapper import Mapperfrom app.mapper.interface.interfaceGroupMapper import InterfaceGroupMapperfrom app.mapper.interface.interfaceCaseMapper import InterfaceCaseMapperfrom app.model.interface import InterfaceResultModel, InterfaceCaseResultModel, InterfaceTaskResultModelfrom app.model import async_sessionfrom app.model.interface.interfaceResultModel import InterfaceGroupResult, InterfaceConditionResultfrom utils import MyLogurufrom sqlalchemy import delete, selectlog = MyLoguru().get_logger()class InterfaceResultMapper(Mapper):    __model__ = InterfaceResultModel    @classmethod    async def query_api_result_by_case(cls, caseResultId: int):        """        业务case 查询结果        """        interface_result = []        try:            async with async_session() as session:                # 首先获取用例ID                case_result = await session.scalar(                    select(InterfaceCaseResultModel.interfaceCaseID).where(                        InterfaceCaseResultModel.id == caseResultId                    )                )                if not case_result:                    return []                # 使用 InterfaceCaseMapper 的 query_content_step 方法获取步骤顺序                contents = await InterfaceCaseMapper.query_content_step(case_result, session)                # 按步骤顺序查询结果                for content in contents:                    # 根据步骤类型确定要查询的接口ID                    target_interface_id = None                    if content.content_type == 1:  # STEP_API                        target_interface_id = content.target_id                    elif content.content_type == 2:  # STEP_API_GROUP                        # 对于组步骤，需要查询组内所有接口的结果                        from app.mapper.interface.interfaceGroupMapper import InterfaceGroupMapper                        group_interfaces = await InterfaceGroupMapper.query_apis(content.target_id)                        for interface in group_interfaces:                            # 查询组内每个接口的结果                            step_results = await session.scalars(                                select(InterfaceResultModel).where(                                    InterfaceResultModel.interface_case_result_Id == caseResultId,                                    InterfaceResultModel.interfaceID == interface.id                                )                            )                            results: List[InterfaceResultModel] = step_results.all()                            for result in results:                                # 处理组结果                                group_info = next((g for g in interface_result if isinstance(g, dict) and g.get("group_id") == result.interface_group_result_id), None)                                if not group_info:                                    group_info = {                                        "group_id": result.interface_group_result_id,                                        "is_group": True,                                        "data": []                                    }                                    interface_result.append(group_info)                                group_info["data"].append(result)                        continue                    if target_interface_id:                        # 查询该步骤对应的结果                        step_results = await session.scalars(                            select(InterfaceResultModel).where(                                InterfaceResultModel.interface_case_result_Id == caseResultId,                                InterfaceResultModel.interfaceID == target_interface_id                            )                        )                        results: List[InterfaceResultModel] = step_results.all()                        for result in results:                            if result.interface_group_result_id:                                # 处理 group 逻辑                                group_info = next((g for g in interface_result if isinstance(g, dict) and g.get("group_id") == result.interface_group_result_id), None)                                if not group_info:                                    group_info = {                                        "group_id": result.interface_group_result_id,                                        "is_group": True,                                        "data": []                                    }                                    interface_result.append(group_info)                                group_info["data"].append(result)                            elif result.interface_condition_result_id:                                # 处理 condition 逻辑                                condition_info = next((c for c in interface_result if isinstance(c, dict) and c.get("condition_id") == result.interface_condition_result_id), None)                                if not condition_info:                                    condition_info = {                                        "condition_id": result.interface_condition_result_id,                                        "is_condition": True,                                        "data": []                                    }                                    interface_result.append(condition_info)                                condition_info["data"].append(result)                            else:                                # 直接添加 api 结果                                interface_result.append(result)                # 添加 group 和 condition 的元信息                for item in interface_result:                    if isinstance(item, dict) and item.get("group_id"):                        group = await InterfaceGroupResultMapper.get_by_id(item.get("group_id"))                        if group:                            item["groupName"] = group.group_name                            item["groupAPINums"] = group.group_api_num                            item['result'] = all(item.result == "SUCCESS" for item in item.get("data"))                    if isinstance(item, dict) and item.get("condition_id"):                        condition = await InterfaceConditionResultMapper.get_by_id(item.get("condition_id"))                        if condition:                            item["conditionName"] = condition.condition_name                            item["conditionAPINums"] = condition.condition_api_result_num                            item['result'] = all(item.result == "SUCCESS" for item in item.get("data"))                return interface_result        except Exception as e:            log.error(e)            raise e    @classmethod    async def set_result(cls,                         **kwargs):        """        接口执行 初始化 结果        """        try:            async with async_session() as session:                async with session.begin():                    c = cls.__model__(                        **kwargs                    )                    await cls.add_flush_expunge(session, c)                    return c        except Exception as e:            log.exception(e)            raise eclass InterfaceCaseResultMapper(Mapper):    __model__ = InterfaceCaseResultModel    @classmethod    async def delete_by_caseId(cls, caseId: int):        """删除"""        try:            async with async_session() as session:                delete_stmt = delete(cls.__model__).where(                    InterfaceCaseResultModel.interfaceCaseID == caseId                )                await session.execute(delete_stmt)                await session.commit()        except Exception as e:            raise e    @classmethod    async def init(cls, **kwargs) -> InterfaceCaseResultModel:        """        初始化        :return:        """        try:            async with async_session() as session:                async with session.begin():                    c = cls.__model__(                        **kwargs                    )                    return await cls.add_flush_expunge(session, c)        except Exception as e:            log.error(e)            raise e    @classmethod    async def set_result_field(cls, caseResult: InterfaceCaseResultModel):        try:            async with async_session() as session:                async with session.begin():                    await cls.add_flush_expunge(session, caseResult)        except Exception as e:            log.error(e)            raise eclass InterfaceTaskResultMapper(Mapper):    __model__ = InterfaceTaskResultModel    @classmethod    async def init(cls, **kwargs) -> InterfaceTaskResultModel:        """        初始化        :return:        """        try:            async with async_session() as session:                async with session.begin():                    t = cls.__model__(                        **kwargs                    )                    await cls.add_flush_expunge(session, t)                    return t        except Exception as e:            log.error(e)            raise e    @classmethod    async def set_result_field(cls, caseResult: InterfaceTaskResultModel):        try:            async with async_session() as session:                async with session.begin():                    await cls.add_flush_expunge(session, caseResult)        except Exception as e:            log.error(e)            raise e    @classmethod    async def delete_by_taskId(cls, taskId: int):        """删除"""        try:            async with async_session() as session:                delete_stmt = delete(cls.__model__).where(                    InterfaceTaskResultModel.taskId == taskId                )                await session.execute(delete_stmt)                await session.commit()        except Exception as e:            raise eclass InterfaceGroupResultMapper(Mapper):    __model__ = InterfaceGroupResult    @classmethod    async def init_model(cls, group_name: str, group_api_num: int, interface_case_result_id: int):        try:            async with async_session() as session:                async with session.begin():                    result = InterfaceGroupResult(                        group_name=group_name,                        group_api_num=group_api_num,                        interface_case_result_id=interface_case_result_id                    )                    return await cls.add_flush_expunge(session, result)        except Exception as e:            log.exception(e)            raise eclass InterfaceConditionResultMapper(Mapper):    __model__ = InterfaceConditionResult    @classmethod    async def init_model(cls, condition_name: str, condition_api_num: int, interface_case_result_id: int):        try:            async with async_session() as session:                async with session.begin():                    result = InterfaceConditionResult(                        condition_name=condition_name,                        condition_api_result_num=condition_api_num,                        interface_case_result_id=interface_case_result_id                    )                    return await cls.add_flush_expunge(session, result)        except Exception as e:            log.exception(e)            raise e__all__ = [    "InterfaceResultMapper",    "InterfaceCaseResultMapper",    "InterfaceTaskResultMapper",    "InterfaceGroupResultMapper",    "InterfaceConditionResultMapper"]