#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/4/3# @Author : cyq# @File : taskClient# @Software: PyCharm# @Desc:from typing import TypeVar, Union, Optionalfrom apscheduler.job import Jobfrom app.exception import CommonErrorfrom app.model.interface import InterfaceTaskfrom app.model.playUI import PlayTaskfrom app.scheduler.aps._trigger import Triggerfrom app.scheduler.aps.base import BaseSchedulerfrom app.scheduler.aps.tasks import ui_task, api_taskfrom utils import MyLogurulog = MyLoguru().get_logger()TaskType = TypeVar('TaskType', bound=Union['PlayTask', 'InterfaceTask'])class TaskScheduler(BaseScheduler):    """    ui api 调度实现    """    async def add_ui_job(self, task: PlayTask) -> Optional[Job]:        return await self.add_job(            func=ui_task,            name=task.title,            job_id=f"UI_{task.uid}",            trigger=Trigger(task.cron),            args=(task.id,)        )    async def add_api_job(self, task: InterfaceTask) -> Optional[Job]:        return await self.add_job(            func=api_task,            name=task.title,            job_id=f"API_{task.uid}",            trigger=Trigger(task.cron),            args=(task.id,)        )    async def modify_task(self, task: TaskType) -> Optional[Job]:        """修改已有任务配置"""        task_type = "UI" if isinstance(task, PlayTask) else "API"        if task_type == "UI" and task.is_auto is False:            return        job_id = f"{task_type}_{task.uid}"        job = await self.get_job(job_id)        if not job:            log.warning(f"Job {job_id} not found, creating new one")            return await (self.add_ui_job(task) if task_type == "UI"                          else self.add_api_job(task))        self.scheduler.modify_job(            job_id=f"{task_type}_{task.uid}",            name=task.title,            trigger=Trigger(task.cron)        )        log.debug(f"modify success {job.next_run_time}")        return jobfrom fastapi import Request, HTTPExceptionasync def get_scheduler(request: Request) -> TaskScheduler:    """依赖注入获取调度器实例"""    scheduler = request.app.scheduler    if not scheduler:        raise CommonError("Scheduler not available")    return scheduler