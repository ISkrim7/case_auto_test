#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/6/20# @Author : cyq# @File : project# @Software: PyCharm# @Desc:from fastapi import APIRouter, Dependsfrom app.controller import Authenticationfrom app.model.base import Userfrom app.response import Responsefrom app.mapper.project import ProjectMapperfrom app.mapper.project.env import EnvMapperfrom app.schema.base import InsertProjectSchema, PageProjectSchema, UpdateProjectSchemafrom app.schema.base.env import InsertEnvSchema, UpdateEnvSchema, PageEnvSchema, DeleteEnvSchema, FilterByEnvSchema, \    EnvFieldfrom common import get_redisrouter = APIRouter(prefix="/project", tags=["项目"])@router.get("/query", description="查询所有项目")async def query_project(_: User = Depends(Authentication()),rc=Depends(get_redis)):    """    查询所有项目    :return:    """    data = await rc.cache_with_key("projects", ProjectMapper.query_all)    return Response.success(data)@router.post("/page", description="分页")async def page_project(pageInfo: PageProjectSchema, _=Depends(Authentication())):    info = await ProjectMapper.page_query(**pageInfo.dict(        exclude_unset=True,        exclude_none=True    ))    return Response.success(info)@router.post('/insert', description="添加项目")async def insert_project(project: InsertProjectSchema,                         auth=Depends(Authentication(isAdmin=True))):    await ProjectMapper.insert_project(        **project.dict(),        creatorUser=auth    )    return Response.success()@router.post('/update', description="修改项目")async def update_project(project: UpdateProjectSchema,                         auth=Depends(Authentication(isAdmin=True))):    await ProjectMapper.update_by_uid(        **project.dict(            exclude_unset=True,            exclude_none=True        ),        updateUser=auth    )    return Response.success()@router.post('/delete', description="删除项目")async def delete_project(project: UpdateProjectSchema,                         _=Depends(Authentication(isAdmin=True))):    await ProjectMapper.delete_by_id(        **project.dict(            exclude_unset=True,            exclude_none=True        )    )    return Response.success()@router.post("/env/insert", description="添加环境")async def insert_env(env: InsertEnvSchema, auth=Depends(Authentication())):    await EnvMapper.save(        **env.dict(),        creatorUser=auth    )    return Response.success()@router.post("/env/update", description="添加环境")async def insert_env(env: UpdateEnvSchema, auth=Depends(Authentication())):    await EnvMapper.update_by_id(        **env.dict(),        updateUser=auth    )    return Response.success()@router.get("/env/queryBy", description="查询环境")async def query_env_by(env: FilterByEnvSchema = Depends(), _=Depends(Authentication())):    envs = await EnvMapper.query_by(**env.dict(        exclude_unset=True,        exclude_none=True    ))    return Response.success(envs)@router.get("/env/detail", description="查询环境")async def get_env_by_id(env: EnvField = Depends(), _=Depends(Authentication())):    env = await EnvMapper.get_by_id(ident=env.id)    return Response.success(env)@router.get("/env/query", description="查询所有环境")async def query_env_by(_=Depends(Authentication())):    envs = await EnvMapper.query_all()    return Response.success(envs)@router.post("/env/page", description="环境分页")async def page_env(pageInfo: PageEnvSchema, _=Depends(Authentication())):    envs = await EnvMapper.page_query(**pageInfo.dict(        exclude_unset=True,        exclude_none=True    ))    return Response.success(envs)@router.post("/env/remove", description="删除环境")async def remove_env(env: DeleteEnvSchema, _=Depends(Authentication())):    await EnvMapper.delete_by_id(ident=env.id)    return Response.success()