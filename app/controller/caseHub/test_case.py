#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/8/25# @Author : cyq# @File : test_case# @Software: PyCharm# @Desc:from fastapi import APIRouter, Depends, UploadFilefrom fastapi.responses import FileResponsefrom app.mapper.caseHub.testcaseMapper import TestCaseMapper, TestCaseStepMapper, CaseDynamicMapperfrom app.schema.hub.testCaseSchema import *from app.controller import Authenticationfrom app.model.base import Userfrom app.response import Responsefrom utils import logrouter = APIRouter(prefix="/hub/cases", tags=['用例'])@router.post("/insert", description="添加用例")async def insert_case(data: AddTestCaseSchema, user: User = Depends(Authentication())):    log.info(data)    data = await TestCaseMapper.save_case(cr=user,                                          **data.model_dump(exclude_unset=True))    return Response.success(data)@router.post("/dataPage", description="分页")async def page_common_case(data: PageTestCaseSchema, _: User = Depends(Authentication())):    log.info(data.model_dump(exclude_none=True))    data = await TestCaseMapper.page_by_module(**data.model_dump(exclude_none=True))    return Response.success(data)@router.post("/addDefault", description="添加默认用例")async def add_default(data: AddDefaultCaseSchema, user: User = Depends(Authentication())):    data = await TestCaseMapper.add_default_case(user=user,                                                 **data.model_dump(exclude_unset=True))    return Response.success(data)@router.post("/update", description="修改用例")async def update_case(data: UpdateTestCaseSchema, ur: User = Depends(Authentication())):    log.info(data)    await TestCaseMapper.update_case(ur=ur, **data.model_dump(exclude_unset=True, exclude_none=True))    return Response.success()@router.get("/queryByReqId", description="用例列表")async def list_case(data: QueryTestCaseSchemaByField = Depends(), _: User = Depends(Authentication())):    # data = await TestCaseMapper.query_by_req(data.requirementId)    data = await TestCaseMapper.query_case_by_field(**data.model_dump(exclude_none=True, exclude_unset=True))    return Response.success(data)@router.get("/queryTagsByReqId", description="用例列表")async def query_tags(data: QueryTestCaseSchemaByField = Depends(), _: User = Depends(Authentication())):    data = await TestCaseMapper.query_tags(data.requirementId)    # data = await TestCaseMapper.query_case_by_field(**data.model_dump(exclude_none=True, exclude_unset=True))    return Response.success(data)@router.get("/queryByField", description="用例列表")async def query_case(data: QueryTestCaseSchemaByField = Depends(), _: User = Depends(Authentication())):    data = await TestCaseMapper.query_case_by_field(**data.model_dump(exclude_none=True, exclude_unset=True))    return Response.success(data)@router.post("/remove", description="删除用例")async def remove_case(data: RemoveCaseSchema, _: User = Depends(Authentication())):    await TestCaseMapper.remove_case(**data.model_dump())    return Response.success()@router.post("/removeStep", description="删除用例")async def remove_case_step(step: RemoveCaseStep, _: User = Depends(Authentication())):    await TestCaseStepMapper.delete_by_id(step.stepId)    return Response.success()@router.post("/copy", description="复制")async def copy_case(data: CopyCase, _: User = Depends(Authentication())):    await TestCaseMapper.copy_case(user=_, **data.model_dump())    return Response.success()@router.post("/copyStep", description="复制")async def copy_case_step(data: CopyCaseStep, _: User = Depends(Authentication())):    await TestCaseStepMapper.copy_step(user=_, **data.model_dump())    return Response.success()@router.post("/handleAddStepLine", description="手动新增默认")async def add_case_step(data: AddDefaultCaseStep, _: User = Depends(Authentication())):    await TestCaseStepMapper.add_default_step(user=_, **data.model_dump())    return Response.success()@router.post("/reorder", description="用例排序")async def reorder_case(data: ReorderCase, _: User = Depends(Authentication())):    await TestCaseMapper.reorder_case(**data.model_dump())    return Response.success()@router.post("/reorderSupStep", description="用例步骤排序")async def reorder_case_step(data: ReorderCaseStep, _: User = Depends(Authentication())):    await TestCaseStepMapper.reorder_steps(**data.model_dump())    return Response.success()@router.get("/querySubSteps/{caseId}", description="用例查询步骤")async def query_sub_steps(caseId: int, _: User = Depends(Authentication())):    steps = await TestCaseMapper.query_sub_steps(caseId)    return Response.success(steps)@router.post("/updateSubSteps", description="用例维护步骤")async def update_sub_step(step: UpdateTestCaseStep, user: User = Depends(Authentication())):    await TestCaseStepMapper.update_step(user=user,                                         **step.model_dump(                                             exclude_unset=True,                                             exclude_none=True),                                         )    return Response.success()@router.get("/queryDynamic/{caseId}", description="用例动态")async def query_dynamic(caseId: int, _: User = Depends(Authentication())):    steps = await CaseDynamicMapper.query_dynamic(caseId)    return Response.success(steps)@router.post("/setTestCaseResult", description="用例测试结果")async def set_test_case_result(data: UpdateTestCaseStatusSchema, user: User = Depends(Authentication())):    await TestCaseMapper.update_case(ur=user, **data.model_dump(exclude_unset=True, exclude_none=True))    return Response.success()@router.post("/upload", description="用例上传")async def upload_case(file: UploadFile, user: User = Depends(Authentication())):    from utils.aioFileReader import AsyncFilesReader    data, messages = await AsyncFilesReader().async_read_excel_for_case(file)    if messages:        return Response.error(            msg=f"到入失败，请检查数据格式：{''.join(messages)}"        )    await TestCaseMapper.insert_upload_case(cases=data,                                            project_id=1,                                            module_id=17,                                            requirementId=1,                                            user=user)    msg = f"成功导入数据{len(data)}条"    return Response.success(        msg=msg    )@router.get("/downloadCaseDemo", description="用例上传")async def download_case_demo(_: User = Depends(Authentication())):    from file import TestCaseDemoFile    return FileResponse(        path=TestCaseDemoFile,        filename="用例模板.xlsx",        media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",    )@router.post("/updateStatus", description="用例状态更新")async def update_status(data: SetCasesStatusSchema, user: User = Depends(Authentication())):    await TestCaseMapper.update_cases_status(        user=user,        **data.model_dump()    )    return Response.success()@router.post("/updateCommon", description="用例状态更新")async def update_common(data: SetCasesCommonSchema, _: User = Depends(Authentication())):    await TestCaseMapper.update_cases_common(        **data.model_dump()    )    return Response.success()