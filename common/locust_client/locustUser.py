#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2025/3/14# @Author : cyq# @File : locustUser# @Software: PyCharm# @Desc:from queue import Queuefrom typing import Optional, Dict, Any, Listfrom locust.clients import ResponseContextManagerfrom app.schema.interface import InterfaceApiSchema, PerfSchema, IAssertfrom locust import HttpUser, task, FastHttpUser, betweenfrom utils import logfrom utils.transform import Transform, SyncTransFormfrom .locustAssert import LocustAssertdef create_dynamic_user_class(apiInfo: InterfaceApiSchema, perfSetting: PerfSchema):    """    动态创建 User 类，根据传入的 API 配置生成对应的测试方法    参数:    - apiInfo: API Info    - perfSetting: Perf信息    """    # 预先初始化队列    DQ = None    if perfSetting.file_name:        from utils.fileManager import FileManager        DQ = FileManager.file_reader_for_perf(perfSetting.file_name, q=True)        log.debug(f"Pre-initialized data queue with {DQ.qsize()} items")    class DynamicApiUser(FastHttpUser):        # 等待时间        wait_time = between(*perfSetting.perf_wait_range)        _data_queue: Optional[Queue] = DQ        _data_initialized = None        @property        def data_queue(self) -> Queue:            return self._data_queue        @task        def dynamic_task(self):            """动态生成的任务方法"""            var_data = None            requestInfo = apiInfo.requestInfo            try:                if self.data_queue:                    var_data = self._get_test_data()                    if var_data:                        requestInfo = self._prepare_request(requestInfo, var_data)                log.debug(f"requestInfo: {requestInfo}")                self._execute_request(apiInfo)            finally:                # 确保数据放回队列                if var_data and self._data_queue:                    self._return_test_data(var_data)        @staticmethod        def _prepare_request(base_request: Dict[str, Any], test_data: Dict[str, Any]) -> Dict[str, Any]:            """准备请求参数"""            try:                return SyncTransForm.transform(base_request, test_data)  # 避免修改原始请求            except Exception as e:                log.error(f"Failed to prepare request: {str(e)}")                raise        def _execute_request(self, api_info: InterfaceApiSchema):            """执行API请求"""            with getattr(self.client, api_info.method.lower())(                    api_info.url,                    name=f"{api_info.method} {api_info.url}",                    catch_response=True,                    **apiInfo.requestInfo            ) as response:                self._handle_response(response, apiInfo.asserts)        @staticmethod        def _handle_response(response: ResponseContextManager, asserts: List[IAssert]):            """            处理API响应            # todo 加入自定义断言            """            if not asserts:                response.success()                return            LocustAssert(response).handle_assert(asserts)        def _get_test_data(self):            """从队列获取测试数据"""            try:                return self.data_queue.get_nowait()            except Exception as e:                log.warning(f"Failed to get test data: {str(e)}")                return None        def _return_test_data(self, data: Dict[str, Any]):            """将测试数据返回队列"""            try:                self.data_queue.put(data)            except Exception as e:                log.warning(f"Failed to return test data to queue: {str(e)}")    return DynamicApiUser