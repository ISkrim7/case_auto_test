#!/usr/bin/env python# -*- coding:utf-8 -*-# @Time : 2024/7/23# @Author : cyq# @File : JsonExtract# @Software: PyCharm# @Desc:import jsonimport jmespathfrom typing import Anyfrom httpx import Responsefrom jsonpath import jsonpathfrom json import JSONDecodeErrorfrom ._myLoguru import MyLogurulog = MyLoguru().get_logger()class JsonExtract:    """    json 提取    jsonpath    jmespath    """    def __init__(self, jsonBody: Response | dict | list[dict[str, Any]], expr: str):        """        :param jsonBody Response.json        :param expr        """        if isinstance(jsonBody, Response):            try:                self.jsonBody = jsonBody.json()            except JSONDecodeError as e:                log.error(f" JsonExtract jsonpath解析失败:{e}")                self.jsonBody = {}        else:            self.jsonBody = jsonBody        self.endStr = None        self.expr = self.handel_expr(expr)    def search(self):        """        jmespath 解析        :return:        """        return jmespath.search(self.expr, self.jsonBody)    async def value(self) -> Any:        """        jsonpath 解析        :return: Any        """        try:            result = jsonpath(self.jsonBody, self.expr)            if result:                if self.endStr:                    return self.funcMap(result[0])                return result[0]            else:                return None        # 可能不是json        except JSONDecodeError as e:            raise e    def handel_expr(self, expr: str) -> str:        """        """        expr = expr.strip()        if expr.endswith("()"):            self.endStr = expr.split(".")[-1]            new = expr.replace("." + self.endStr, "")            return new        return expr    def funcMap(self, data):        """        jsonpath 增加长度        $.data.length()        """        func_Map = {            "length()": len        }        func = func_Map.get(self.endStr)        if func:            if data:                return func(data)        return data